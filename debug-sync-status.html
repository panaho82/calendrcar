<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Sync CalendrCar</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        button { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #2563eb; }
        .success { color: #059669; }
        .error { color: #dc2626; }
        .warning { color: #d97706; }
        .info { color: #0369a1; }
        .data-box { 
            background: #f8fafc; 
            border: 1px solid #e2e8f0; 
            border-radius: 5px; 
            padding: 15px; 
            margin: 10px 0; 
        }
        .data-item {
            background: #fff;
            border-left: 4px solid #3b82f6;
            padding: 10px;
            margin: 5px 0;
            border-radius: 0 5px 5px 0;
        }
        pre { 
            background: #1e293b; 
            color: #e2e8f0; 
            padding: 15px; 
            border-radius: 5px; 
            overflow-x: auto; 
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Synchronisation CalendrCar</h1>
        
        <div>
            <h2>1. √âtat des Donn√©es Supabase</h2>
            <button onclick="checkSupabaseData()">üìä V√©rifier Donn√©es Supabase</button>
            <div id="supabaseDataResult"></div>
        </div>
        
        <div>
            <h2>2. √âtat localStorage (Navigateur Actuel)</h2>
            <button onclick="checkLocalStorageData()">üíæ V√©rifier localStorage</button>
            <div id="localStorageResult"></div>
        </div>
        
        <div>
            <h2>3. Test Synchronisation Bidirectionnelle</h2>
            <button onclick="testBidirectionalSync()">üîÑ Test Sync Bidirectionnelle</button>
            <div id="syncTestResult"></div>
        </div>
        
        <div>
            <h2>4. Forcer Synchronisation Compl√®te</h2>
            <button onclick="forceSyncFromSupabase()">‚¨áÔ∏è Forcer Sync Depuis Supabase</button>
            <button onclick="forceSyncToSupabase()">‚¨ÜÔ∏è Forcer Sync Vers Supabase</button>
            <div id="forceSyncResult"></div>
        </div>

        <div>
            <h2>5. Nettoyer et R√©initialiser</h2>
            <button onclick="clearLocalData()">üóëÔ∏è Vider localStorage</button>
            <button onclick="clearSupabaseData()">üóëÔ∏è Vider Supabase</button>
            <div id="clearResult"></div>
        </div>
        
        <div id="logs"></div>
    </div>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://zrcmjmbkehiyspmqalzk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpyY21qbWJrZWhpeXNwbXFhbHprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM3NjI0ODgsImV4cCI6MjA0OTMzODQ4OH0.VhxAn5M42LvOe_YgYxcYy3vAjHKA7lOgqJaOmCcxHDY';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `data-item ${type}`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            logsDiv.appendChild(logDiv);
            console.log(message);
        }
        
        async function checkSupabaseData() {
            const resultDiv = document.getElementById('supabaseDataResult');
            resultDiv.innerHTML = '<p class="info">üîÑ V√©rification en cours...</p>';
            
            try {
                // V√©rifier v√©hicules
                const { data: vehicles, error: vError } = await supabase
                    .from('vehicles')
                    .select('*');
                
                // V√©rifier r√©servations
                const { data: reservations, error: rError } = await supabase
                    .from('reservations')
                    .select('*');

                if (vError || rError) {
                    throw new Error(\`Vehicles: \${vError?.message || 'OK'}, Reservations: \${rError?.message || 'OK'}\`);
                }
                
                let result = '<div class="data-box">';
                result += \`<h3>üìä Donn√©es Supabase</h3>\`;
                result += \`<div class="data-item success">‚úÖ V√©hicules: \${vehicles?.length || 0} trouv√©s</div>\`;
                result += \`<div class="data-item success">‚úÖ R√©servations: \${reservations?.length || 0} trouv√©es</div>\`;
                
                if (vehicles && vehicles.length > 0) {
                    result += \`<h4>üöó V√©hicules:</h4>\`;
                    vehicles.forEach(v => {
                        result += \`<div class="data-item">\${v.name} (\${v.plate}) - \${v.status}</div>\`;
                    });
                }
                
                if (reservations && reservations.length > 0) {
                    result += \`<h4>üìÖ R√©servations:</h4>\`;
                    reservations.forEach(r => {
                        result += \`<div class="data-item">\${r.title} - \${r.client} (\${r.vehicleId}) - \${r.status}</div>\`;
                    });
                }
                
                result += '</div>';
                resultDiv.innerHTML = result;
                log(\`‚úÖ Supabase: \${vehicles?.length || 0} v√©hicules, \${reservations?.length || 0} r√©servations\`, 'success');
                
            } catch (error) {
                resultDiv.innerHTML = \`<p class="error">‚ùå Erreur: \${error.message}</p>\`;
                log(\`‚ùå Erreur Supabase: \${error.message}\`, 'error');
            }
        }
        
        async function checkLocalStorageData() {
            const resultDiv = document.getElementById('localStorageResult');
            
            try {
                const vehiclesStr = localStorage.getItem('calendrcar-vehicles');
                const reservationsStr = localStorage.getItem('calendrcar-reservations');
                
                const vehicles = vehiclesStr ? JSON.parse(vehiclesStr) : [];
                const reservations = reservationsStr ? JSON.parse(reservationsStr) : [];
                
                let result = '<div class="data-box">';
                result += \`<h3>üíæ localStorage</h3>\`;
                result += \`<div class="data-item info">üìä V√©hicules: \${vehicles.length} trouv√©s</div>\`;
                result += \`<div class="data-item info">üìä R√©servations: \${reservations.length} trouv√©es</div>\`;
                
                if (vehicles.length > 0) {
                    result += \`<h4>üöó V√©hicules localStorage:</h4>\`;
                    vehicles.forEach(v => {
                        result += \`<div class="data-item">\${v.name} (\${v.plate}) - \${v.status}</div>\`;
                    });
                }
                
                if (reservations.length > 0) {
                    result += \`<h4>üìÖ R√©servations localStorage:</h4>\`;
                    reservations.forEach(r => {
                        result += \`<div class="data-item">\${r.title} - \${r.client} (\${r.vehicleId}) - \${r.status}</div>\`;
                    });
                }
                
                result += '</div>';
                resultDiv.innerHTML = result;
                log(\`üíæ localStorage: \${vehicles.length} v√©hicules, \${reservations.length} r√©servations\`, 'info');
                
            } catch (error) {
                resultDiv.innerHTML = \`<p class="error">‚ùå Erreur localStorage: \${error.message}</p>\`;
                log(\`‚ùå Erreur localStorage: \${error.message}\`, 'error');
            }
        }
        
        async function forceSyncFromSupabase() {
            const resultDiv = document.getElementById('forceSyncResult');
            resultDiv.innerHTML = '<p class="info">‚¨áÔ∏è Synchronisation depuis Supabase...</p>';
            
            try {
                // R√©cup√©rer depuis Supabase
                const { data: vehicles } = await supabase.from('vehicles').select('*');
                const { data: reservations } = await supabase.from('reservations').select('*');
                
                // Sauvegarder en localStorage
                if (vehicles) {
                    localStorage.setItem('calendrcar-vehicles', JSON.stringify(vehicles));
                }
                if (reservations) {
                    const formattedReservations = reservations.map(r => ({
                        ...r,
                        startTime: new Date(r.startTime),
                        endTime: new Date(r.endTime)
                    }));
                    localStorage.setItem('calendrcar-reservations', JSON.stringify(formattedReservations));
                }
                
                resultDiv.innerHTML = \`<p class="success">‚úÖ Synchronisation termin√©e: \${vehicles?.length || 0} v√©hicules, \${reservations?.length || 0} r√©servations</p>\`;
                log(\`‚úÖ Sync depuis Supabase: \${vehicles?.length || 0} v√©hicules, \${reservations?.length || 0} r√©servations\`, 'success');
                
            } catch (error) {
                resultDiv.innerHTML = \`<p class="error">‚ùå Erreur sync: \${error.message}</p>\`;
                log(\`‚ùå Erreur sync depuis Supabase: \${error.message}\`, 'error');
            }
        }
        
        async function forceSyncToSupabase() {
            const resultDiv = document.getElementById('forceSyncResult');
            resultDiv.innerHTML = '<p class="info">‚¨ÜÔ∏è Synchronisation vers Supabase...</p>';
            
            try {
                // R√©cup√©rer depuis localStorage
                const vehiclesStr = localStorage.getItem('calendrcar-vehicles');
                const reservationsStr = localStorage.getItem('calendrcar-reservations');
                
                if (vehiclesStr) {
                    const vehicles = JSON.parse(vehiclesStr);
                    await supabase.from('vehicles').delete().neq('id', '');
                    await supabase.from('vehicles').insert(vehicles);
                    log(\`‚¨ÜÔ∏è \${vehicles.length} v√©hicules envoy√©s vers Supabase\`, 'info');
                }
                
                if (reservationsStr) {
                    const reservations = JSON.parse(reservationsStr);
                    const formattedReservations = reservations.map(r => ({
                        ...r,
                        startTime: r.startTime instanceof Date ? r.startTime.toISOString() : new Date(r.startTime).toISOString(),
                        endTime: r.endTime instanceof Date ? r.endTime.toISOString() : new Date(r.endTime).toISOString()
                    }));
                    
                    await supabase.from('reservations').delete().neq('id', '');
                    await supabase.from('reservations').insert(formattedReservations);
                    log(\`‚¨ÜÔ∏è \${reservations.length} r√©servations envoy√©es vers Supabase\`, 'info');
                }
                
                resultDiv.innerHTML = '<p class="success">‚úÖ Donn√©es localStorage synchronis√©es vers Supabase</p>';
                
            } catch (error) {
                resultDiv.innerHTML = \`<p class="error">‚ùå Erreur sync: \${error.message}</p>\`;
                log(\`‚ùå Erreur sync vers Supabase: \${error.message}\`, 'error');
            }
        }
        
        async function clearLocalData() {
            localStorage.removeItem('calendrcar-vehicles');
            localStorage.removeItem('calendrcar-reservations');
            document.getElementById('clearResult').innerHTML = '<p class="warning">‚ö†Ô∏è localStorage vid√©</p>';
            log('üóëÔ∏è localStorage vid√©', 'warning');
        }
        
        async function clearSupabaseData() {
            try {
                await supabase.from('vehicles').delete().neq('id', '');
                await supabase.from('reservations').delete().neq('id', '');
                document.getElementById('clearResult').innerHTML = '<p class="warning">‚ö†Ô∏è Supabase vid√©</p>';
                log('üóëÔ∏è Supabase vid√©', 'warning');
            } catch (error) {
                document.getElementById('clearResult').innerHTML = \`<p class="error">‚ùå Erreur: \${error.message}</p>\`;
                log(\`‚ùå Erreur vidage Supabase: \${error.message}\`, 'error');
            }
        }
    </script>
</body>
</html> 