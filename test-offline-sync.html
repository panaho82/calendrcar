<!DOCTYPE html>
<html>
<head>
    <title>üì¥ Test Synchronisation Hors Ligne - CalendrCar</title>
    <meta charset="UTF-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f8f9fa; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            font-weight: 500;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .offline { background: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }
        
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px; 
            font-weight: bold; 
        }
        button:hover { background: #0056b3; }
        button.offline { background: #6c757d; }
        button.offline:hover { background: #5a6268; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        
        .test-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        .test-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        .test-card.online {
            border-color: #28a745;
            background: #f8fff9;
        }
        .test-card.offline {
            border-color: #dc3545;
            background: #fff8f8;
        }
        
        h1 { color: #333; text-align: center; }
        h2 { color: #555; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        
        .connection-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connection-indicator.online {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        .connection-indicator.offline {
            background: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .queue-counter {
            background: #ffc107;
            color: #212529;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .scenario {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¥ Test Synchronisation Hors Ligne</h1>
        
        <div id="connectionStatus" class="status info">
            <span class="connection-indicator online" id="connectionIndicator"></span>
            <strong>Connexion:</strong> <span id="connectionText">En ligne</span>
            <span class="queue-counter" id="queueCounter" style="display: none;">0 en attente</span>
        </div>

        <div class="scenario">
            <strong>üéØ SC√âNARIO DE TEST :</strong><br><br>
            
            <strong>1. Simulation Hors Ligne :</strong><br>
            ‚Ä¢ D√©sactiver manuellement la connexion (Avion/WiFi)<br>
            ‚Ä¢ Cr√©er/modifier des r√©servations ‚Üí Sauvegarde localStorage + queue<br><br>
            
            <strong>2. Retour En Ligne :</strong><br>
            ‚Ä¢ R√©activer la connexion ‚Üí D√©tection automatique<br>
            ‚Ä¢ Synchronisation de rattrapage ‚Üí Upload vers Supabase<br>
            ‚Ä¢ Propagation temps r√©el ‚Üí Autres appareils<br><br>
            
            <strong>‚úÖ SUCC√àS si :</strong><br>
            ‚Ä¢ Donn√©es cr√©√©es hors ligne apparaissent sur autres appareils<br>
            ‚Ä¢ Notification "X actions hors ligne synchronis√©es"<br>
            ‚Ä¢ Queue vid√©e automatiquement
        </div>

        <h2>üõ†Ô∏è Outils de Test</h2>
        
        <div class="test-grid">
            <div class="test-card online" id="onlineCard">
                <h3>üåê Mode En Ligne</h3>
                <button onclick="createTestReservationOnline()" class="success">‚úÖ Cr√©er R√©servation (En ligne)</button>
                <button onclick="checkSyncStatus()">üìä V√©rifier Statut Sync</button>
                <button onclick="forceBackgroundSync()">üîÑ Forcer Sync Temps R√©el</button>
            </div>
            
            <div class="test-card offline" id="offlineCard">
                <h3>üì¥ Mode Hors Ligne</h3>
                <button onclick="simulateOfflineAction()" class="offline">üì± Simuler Action Hors Ligne</button>
                <button onclick="showOfflineQueue()" class="offline">üìã Voir Queue Hors Ligne</button>
                <button onclick="clearOfflineQueue()" class="danger">üóëÔ∏è Vider Queue</button>
            </div>
            
            <div class="test-card">
                <h3>‚ö° Synchronisation</h3>
                <button onclick="triggerCatchupSync()">üì° D√©clencher Rattrapage</button>
                <button onclick="performSmartSync()">üß† Sync Intelligente</button>
                <button onclick="testConnectionDetection()">üì∂ Test D√©tection Connexion</button>
            </div>
        </div>

        <div id="results"></div>

        <h2>üìã Instructions D√©taill√©es</h2>
        <div class="status warning">
            <strong>Test Manuel Complet :</strong><br><br>
            
            <strong>√âTAPE 1 - Pr√©paration :</strong><br>
            ‚Ä¢ Ouvrir https://mm-calendrcar.netlify.app/ sur 2 appareils<br>
            ‚Ä¢ V√©rifier que la sync temps r√©el fonctionne<br><br>
            
            <strong>√âTAPE 2 - Simulation Hors Ligne :</strong><br>
            ‚Ä¢ Sur appareil 1 : D√©sactiver WiFi/Data<br>
            ‚Ä¢ Cr√©er 2-3 nouvelles r√©servations<br>
            ‚Ä¢ V√©rifier notifications "Mode hors ligne - donn√©es sauv√©es localement"<br>
            ‚Ä¢ V√©rifier badge orange dans sidebar avec nombre d'actions<br><br>
            
            <strong>√âTAPE 3 - Retour En Ligne :</strong><br>
            ‚Ä¢ R√©activer WiFi/Data sur appareil 1<br>
            ‚Ä¢ Observer notification "Retour en ligne - synchronisation..."<br>
            ‚Ä¢ Attendre notification "X actions hors ligne synchronis√©es"<br><br>
            
            <strong>√âTAPE 4 - V√©rification :</strong><br>
            ‚Ä¢ Sur appareil 2 : Voir les nouvelles r√©servations appara√Ætre (10-15s)<br>
            ‚Ä¢ Badge orange dispara√Æt sur appareil 1<br>
            ‚Ä¢ Planning √† jour sur tous appareils<br><br>
            
            <strong>üéØ R√âSULTAT ATTENDU :</strong><br>
            Synchronisation transparente des donn√©es cr√©√©es hors ligne vers tous les appareils connect√©s !
        </div>
    </div>

    <script>
        let isOnlineSimulated = navigator.onLine;
        let offlineQueueSimulated = [];
        
        function addResult(type, title, content) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${title}</strong><br>${content}<br><small>${new Date().toLocaleTimeString()}</small>`;
            results.insertBefore(div, results.firstChild);
            
            // Garder seulement les 8 derniers r√©sultats
            while (results.children.length > 8) {
                results.removeChild(results.lastChild);
            }
        }

        function updateConnectionStatus() {
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            const counter = document.getElementById('queueCounter');
            const status = document.getElementById('connectionStatus');
            
            if (isOnlineSimulated) {
                indicator.className = 'connection-indicator online';
                text.textContent = 'En ligne';
                status.className = 'status success';
                counter.style.display = 'none';
            } else {
                indicator.className = 'connection-indicator offline';
                text.textContent = 'Hors ligne';
                status.className = 'status error';
                
                if (offlineQueueSimulated.length > 0) {
                    counter.style.display = 'inline';
                    counter.textContent = `${offlineQueueSimulated.length} en attente`;
                } else {
                    counter.style.display = 'none';
                }
            }
        }

        async function createTestReservationOnline() {
            if (!isOnlineSimulated) {
                addResult('warning', '‚ö†Ô∏è Mode hors ligne', 'Impossible de cr√©er en ligne - mode hors ligne actif');
                return;
            }
            
            try {
                // Simuler cr√©ation r√©servation en ligne
                const testReservation = {
                    id: 'online-' + Date.now(),
                    title: 'TEST R√©servation En Ligne',
                    client: 'Client En Ligne',
                    phone: '0123456789',
                    vehicleId: '208-1',
                    startTime: new Date(Date.now() + 3600000),
                    endTime: new Date(Date.now() + 7200000),
                    status: 'confirmed'
                };

                addResult('success', '‚úÖ R√©servation cr√©√©e en ligne', 
                    `ID: ${testReservation.id}<br>` +
                    `Client: ${testReservation.client}<br>` +
                    `V√©hicule: ${testReservation.vehicleId}<br>` +
                    `<strong>‚û°Ô∏è Sauvegarde directe Supabase + Sync temps r√©el</strong>`
                );
                
            } catch (error) {
                addResult('error', '‚ùå Erreur cr√©ation en ligne', error.message);
            }
        }

        function simulateOfflineAction() {
            // Simuler passage hors ligne
            isOnlineSimulated = false;
            updateConnectionStatus();
            
            // Simuler action hors ligne
            const offlineAction = {
                id: 'offline-' + Date.now(),
                type: 'create',
                entity: 'reservation',
                data: {
                    title: 'TEST R√©servation Hors Ligne',
                    client: 'Client Hors Ligne',
                    phone: '0987654321',
                    vehicleId: '208-2'
                },
                timestamp: Date.now()
            };
            
            offlineQueueSimulated.push(offlineAction);
            updateConnectionStatus();
            
            addResult('warning', 'üì¥ Action hors ligne simul√©e', 
                `Type: ${offlineAction.type} ${offlineAction.entity}<br>` +
                `Client: ${offlineAction.data.client}<br>` +
                `Queue: ${offlineQueueSimulated.length} action(s)<br>` +
                `<strong>üíæ Sauv√© en localStorage + ajout√© √† la queue</strong>`
            );
        }

        function showOfflineQueue() {
            if (offlineQueueSimulated.length === 0) {
                addResult('info', 'üìã Queue vide', 'Aucune action en attente de synchronisation');
                return;
            }
            
            let queueDetails = '';
            offlineQueueSimulated.forEach((action, index) => {
                queueDetails += `${index + 1}. ${action.type} ${action.entity} - ${action.data.client || action.data.name}<br>`;
            });
            
            addResult('info', 'üìã Queue hors ligne', 
                `${offlineQueueSimulated.length} action(s) en attente:<br><br>` +
                queueDetails +
                `<br><strong>Ces actions seront synchronis√©es au retour en ligne</strong>`
            );
        }

        function clearOfflineQueue() {
            const queueSize = offlineQueueSimulated.length;
            offlineQueueSimulated = [];
            updateConnectionStatus();
            
            addResult('info', 'üóëÔ∏è Queue vid√©e', 
                `${queueSize} action(s) supprim√©e(s) de la queue<br>` +
                `<strong>‚ö†Ô∏è Ces donn√©es ne seront PAS synchronis√©es</strong>`
            );
        }

        async function triggerCatchupSync() {
            if (!isOnlineSimulated) {
                // Simuler retour en ligne
                isOnlineSimulated = true;
                updateConnectionStatus();
                
                addResult('info', 'üåê Simulation retour en ligne', 
                    'Connexion restaur√©e - d√©clenchement synchronisation de rattrapage...'
                );
                
                // Simuler d√©lai de synchronisation
                setTimeout(() => {
                    const syncedActions = offlineQueueSimulated.length;
                    offlineQueueSimulated = [];
                    updateConnectionStatus();
                    
                    if (syncedActions > 0) {
                        addResult('success', '‚úÖ Synchronisation de rattrapage r√©ussie', 
                            `${syncedActions} action(s) hors ligne synchronis√©e(s)<br>` +
                            `üì§ Upload√©es vers Supabase<br>` +
                            `üîÑ Propagation vers autres appareils<br>` +
                            `<strong>Planning mis √† jour sur tous les appareils !</strong>`
                        );
                    } else {
                        addResult('info', 'üì° Retour en ligne', 'Aucune action en attente - pas de synchronisation n√©cessaire');
                    }
                }, 2000);
                
            } else {
                addResult('info', 'üîÑ Synchronisation manuelle', 'V√©rification des donn√©es √† synchroniser...');
            }
        }

        function performSmartSync() {
            addResult('info', 'üß† Synchronisation intelligente', 
                'Comparaison donn√©es locales vs distantes...<br>' +
                '‚Ä¢ D√©tection des modifications r√©centes<br>' +
                '‚Ä¢ Upload prioritaire si donn√©es locales plus r√©centes<br>' +
                '‚Ä¢ Merge intelligent des conflits'
            );
        }

        function testConnectionDetection() {
            addResult('info', 'üì∂ Test d√©tection connexion', 
                `Statut actuel: ${navigator.onLine ? 'En ligne' : 'Hors ligne'}<br>` +
                `Simulation: ${isOnlineSimulated ? 'En ligne' : 'Hors ligne'}<br>` +
                `Queue simul√©e: ${offlineQueueSimulated.length} action(s)<br><br>` +
                `<strong>Events:</strong> online/offline du navigateur<br>` +
                `<strong>Service:</strong> offlineQueueService actif`
            );
        }

        async function checkSyncStatus() {
            addResult('info', 'üìä Statut de synchronisation', 
                `üåê Connexion: ${isOnlineSimulated ? 'En ligne' : 'Hors ligne'}<br>` +
                `üìã Queue: ${offlineQueueSimulated.length} action(s)<br>` +
                `‚è±Ô∏è Sync temps r√©el: ${isOnlineSimulated ? 'Active (10s)' : 'Suspendue'}<br>` +
                `üíæ localStorage: Toujours actif<br>` +
                `‚òÅÔ∏è Supabase: ${isOnlineSimulated ? 'Disponible' : 'Indisponible'}`
            );
        }

        function forceBackgroundSync() {
            if (isOnlineSimulated) {
                addResult('success', 'üîÑ Sync temps r√©el forc√©e', 
                    'V√©rification imm√©diate des changements distants...<br>' +
                    'Mise √† jour de l\'interface si nouvelles donn√©es d√©tect√©es'
                );
            } else {
                addResult('warning', '‚ö†Ô∏è Sync temps r√©el suspendue', 
                    'Mode hors ligne - sync temps r√©el sera reprise au retour en ligne'
                );
            }
        }

        // √âcouter les vrais √©v√©nements de connexion
        window.addEventListener('online', () => {
            addResult('success', 'üåê CONNEXION RESTAUR√âE', 
                '√âv√©nement "online" d√©tect√© par le navigateur<br>' +
                '<strong>L\'app va d√©clencher la synchronisation de rattrapage automatiquement</strong>'
            );
        });

        window.addEventListener('offline', () => {
            addResult('error', 'üì¥ CONNEXION PERDUE', 
                '√âv√©nement "offline" d√©tect√© par le navigateur<br>' +
                '<strong>L\'app va passer en mode queue hors ligne</strong>'
            );
        });

        // Initialisation
        window.addEventListener('load', () => {
            updateConnectionStatus();
            addResult('info', 'üöÄ Test Hors Ligne Pr√™t', 
                'Utilisez les boutons pour simuler des sc√©narios hors ligne.<br>' +
                'Le vrai test consiste √† d√©sactiver WiFi/Data et cr√©er des r√©servations dans l\'app.'
            );
        });
    </script>
</body>
</html> 