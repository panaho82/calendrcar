<!DOCTYPE html>
<html>
<head>
    <title>üîÑ Test Synchronisation Temps R√©el - CalendrCar</title>
    <meta charset="UTF-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f8f9fa; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            font-weight: 500;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px; 
            font-weight: bold; 
        }
        button:hover { background: #0056b3; }
        button.test { background: #28a745; }
        button.test:hover { background: #218838; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        
        .test-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        .test-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        .test-card.active {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        h1 { color: #333; text-align: center; }
        h2 { color: #555; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        
        .realtime-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .realtime-indicator.active {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        .realtime-indicator.inactive {
            background: #6c757d;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .countdown {
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Test Synchronisation Temps R√©el</h1>
        
        <div class="status info">
            <strong>üéØ OBJECTIF :</strong><br>
            V√©rifier que les modifications sur un appareil apparaissent automatiquement sur l'autre SANS appuyer sur F5.<br>
            <strong>Fr√©quence :</strong> V√©rification toutes les 10 secondes
        </div>

        <h2>üöÄ Contr√¥les de Test</h2>
        
        <div class="test-grid">
            <div class="test-card">
                <h3>üì± Simulation Appareil 1</h3>
                <button onclick="createTestReservation()" class="test">Cr√©er R√©servation Test</button>
                <button onclick="updateTestReservation()" class="test">Modifier R√©servation</button>
                <button onclick="deleteTestReservation()" class="danger">Supprimer R√©servation</button>
            </div>
            
            <div class="test-card">
                <h3>üíª Simulation Appareil 2</h3>
                <button onclick="monitorChanges()" class="test">üì° Surveiller Changements</button>
                <button onclick="checkSyncStatus()">üîç V√©rifier Statut Sync</button>
                <button onclick="forceSync()">‚ö° Forcer Synchronisation</button>
            </div>
        </div>

        <h2>üìä Statut Temps R√©el</h2>
        
        <div id="syncStatus" class="status info">
            <div>
                <span class="realtime-indicator inactive" id="syncIndicator"></span>
                <strong>Synchronisation :</strong> <span id="syncText">Initialisation...</span>
            </div>
            <div style="margin-top: 10px;">
                <strong>Prochaine v√©rification dans :</strong> <span class="countdown" id="countdown">--</span>
            </div>
        </div>

        <div id="results"></div>

        <h2>üìã Instructions de Test</h2>
        <div class="status warning">
            <strong>Comment tester :</strong><br><br>
            
            <strong>1. Sur appareil 1 (PC) :</strong><br>
            ‚Ä¢ Ouvrir https://mm-calendrcar.netlify.app/<br>
            ‚Ä¢ Cr√©er une nouvelle r√©servation<br><br>
            
            <strong>2. Sur appareil 2 (Mobile) :</strong><br>
            ‚Ä¢ Ouvrir la m√™me URL<br>
            ‚Ä¢ Attendre 10-15 secondes SANS actualiser<br>
            ‚Ä¢ ‚úÖ La nouvelle r√©servation devrait appara√Ætre automatiquement<br><br>
            
            <strong>3. Test inverse :</strong><br>
            ‚Ä¢ Modifier sur mobile ‚Üí v√©rifier sur PC<br><br>
            
            <strong>üéØ SUCC√àS si :</strong><br>
            ‚Ä¢ Les changements apparaissent sans F5<br>
            ‚Ä¢ Message "üîÑ Donn√©es synchronis√©es automatiquement"<br>
            ‚Ä¢ Indicateur bleu clignotant dans la sidebar
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zrcmjmbkehiyspmqalzk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpyY21qbWJrZWhpeXNwbXFhbHprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MTU4MTksImV4cCI6MjA2Njk5MTgxOX0.t_HWBYsUK-qJrU-GjQ314Irr1DsiArbci0i7xXen9DM';
        
        let monitoringActive = false;
        let lastKnownData = { reservations: [], vehicles: [] };
        let countdownInterval = null;
        
        function addResult(type, title, content) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${title}</strong><br>${content}<br><small>${new Date().toLocaleTimeString()}</small>`;
            results.insertBefore(div, results.firstChild);
            
            // Garder seulement les 10 derniers r√©sultats
            while (results.children.length > 10) {
                results.removeChild(results.lastChild);
            }
        }

        async function createTestReservation() {
            try {
                const testReservation = {
                    id: 'test-' + Date.now(),
                    title: 'TEST R√©servation Temps R√©el',
                    client: 'Test Client',
                    phone: '0123456789',
                    vehicleid: '208-1',
                    starttime: new Date(Date.now() + 60000).toISOString(), // Dans 1 minute
                    endtime: new Date(Date.now() + 3660000).toISOString(), // Dans 1h1min
                    status: 'confirmed',
                    notes: 'Cr√©√© par test temps r√©el',
                    amount: 50
                };

                const response = await fetch(`${SUPABASE_URL}/rest/v1/reservations`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify([testReservation])
                });

                if (response.ok) {
                    addResult('success', '‚úÖ R√©servation test cr√©√©e', 
                        `ID: ${testReservation.id}<br>` +
                        `V√©hicule: ${testReservation.vehicleid}<br>` +
                        `Client: ${testReservation.client}<br><br>` +
                        `<strong>‚û°Ô∏è V√©rifiez sur l'autre appareil dans 10-15 secondes</strong>`
                    );
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addResult('error', '‚ùå Erreur cr√©ation', error.message);
            }
        }

        async function updateTestReservation() {
            try {
                // Chercher une r√©servation test existante
                const response = await fetch(`${SUPABASE_URL}/rest/v1/reservations?title=like.TEST*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                const reservations = await response.json();
                
                if (reservations.length > 0) {
                    const reservation = reservations[0];
                    const updatedData = {
                        notes: `Modifi√© le ${new Date().toLocaleTimeString()}`,
                        amount: Math.floor(Math.random() * 100) + 20
                    };

                    const updateResponse = await fetch(`${SUPABASE_URL}/rest/v1/reservations?id=eq.${reservation.id}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedData)
                    });

                    if (updateResponse.ok) {
                        addResult('success', '‚úÖ R√©servation modifi√©e', 
                            `ID: ${reservation.id}<br>` +
                            `Nouvelles notes: ${updatedData.notes}<br>` +
                            `Nouveau montant: ${updatedData.amount}‚Ç¨<br><br>` +
                            `<strong>‚û°Ô∏è V√©rifiez le changement sur l'autre appareil</strong>`
                        );
                    } else {
                        throw new Error(`HTTP ${updateResponse.status}`);
                    }
                } else {
                    addResult('warning', '‚ö†Ô∏è Aucune r√©servation test', 'Cr√©ez d\'abord une r√©servation test');
                }
            } catch (error) {
                addResult('error', '‚ùå Erreur modification', error.message);
            }
        }

        async function deleteTestReservation() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/reservations?title=like.TEST*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                const reservations = await response.json();
                
                if (reservations.length > 0) {
                    const reservation = reservations[0];

                    const deleteResponse = await fetch(`${SUPABASE_URL}/rest/v1/reservations?id=eq.${reservation.id}`, {
                        method: 'DELETE',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    });

                    if (deleteResponse.ok) {
                        addResult('success', '‚úÖ R√©servation supprim√©e', 
                            `ID: ${reservation.id}<br>` +
                            `Client: ${reservation.client}<br><br>` +
                            `<strong>‚û°Ô∏è V√©rifiez la suppression sur l'autre appareil</strong>`
                        );
                    } else {
                        throw new Error(`HTTP ${deleteResponse.status}`);
                    }
                } else {
                    addResult('warning', '‚ö†Ô∏è Aucune r√©servation test', 'Aucune r√©servation test √† supprimer');
                }
            } catch (error) {
                addResult('error', '‚ùå Erreur suppression', error.message);
            }
        }

        async function monitorChanges() {
            if (monitoringActive) {
                monitoringActive = false;
                document.getElementById('syncIndicator').className = 'realtime-indicator inactive';
                document.getElementById('syncText').textContent = 'Surveillance arr√™t√©e';
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                addResult('info', 'üõë Surveillance arr√™t√©e', 'Monitoring des changements d√©sactiv√©');
                return;
            }

            monitoringActive = true;
            document.getElementById('syncIndicator').className = 'realtime-indicator active';
            document.getElementById('syncText').textContent = 'Surveillance active';
            
            // Charger les donn√©es initiales
            try {
                const reservationsResponse = await fetch(`${SUPABASE_URL}/rest/v1/reservations`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                const vehiclesResponse = await fetch(`${SUPABASE_URL}/rest/v1/vehicles`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                lastKnownData.reservations = await reservationsResponse.json();
                lastKnownData.vehicles = await vehiclesResponse.json();

                addResult('info', 'üì° Surveillance d√©marr√©e', 
                    `Surveillance des changements activ√©e<br>` +
                    `Donn√©es initiales: ${lastKnownData.reservations.length} r√©servations, ${lastKnownData.vehicles.length} v√©hicules<br>` +
                    `V√©rification toutes les 10 secondes`
                );

                // D√©marrer le countdown
                startCountdown();

            } catch (error) {
                addResult('error', '‚ùå Erreur surveillance', error.message);
            }
        }

        function startCountdown() {
            let seconds = 10;
            document.getElementById('countdown').textContent = seconds + 's';
            
            countdownInterval = setInterval(async () => {
                seconds--;
                document.getElementById('countdown').textContent = seconds + 's';
                
                if (seconds === 0) {
                    if (monitoringActive) {
                        await checkForChanges();
                        seconds = 10; // Restart countdown
                    } else {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                }
            }, 1000);
        }

        async function checkForChanges() {
            try {
                const reservationsResponse = await fetch(`${SUPABASE_URL}/rest/v1/reservations`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                const vehiclesResponse = await fetch(`${SUPABASE_URL}/rest/v1/vehicles`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                const currentReservations = await reservationsResponse.json();
                const currentVehicles = await vehiclesResponse.json();

                // Comparer les donn√©es
                const reservationsChanged = JSON.stringify(lastKnownData.reservations) !== JSON.stringify(currentReservations);
                const vehiclesChanged = JSON.stringify(lastKnownData.vehicles) !== JSON.stringify(currentVehicles);

                if (reservationsChanged || vehiclesChanged) {
                    const changes = [];
                    
                    if (reservationsChanged) {
                        const diff = currentReservations.length - lastKnownData.reservations.length;
                        changes.push(`üìÖ R√©servations: ${currentReservations.length} (${diff > 0 ? '+' : ''}${diff})`);
                    }
                    
                    if (vehiclesChanged) {
                        const diff = currentVehicles.length - lastKnownData.vehicles.length;
                        changes.push(`üöó V√©hicules: ${currentVehicles.length} (${diff > 0 ? '+' : ''}${diff})`);
                    }

                    addResult('success', 'üîÑ CHANGEMENT D√âTECT√â !', 
                        `${changes.join('<br>')}<br><br>` +
                        `<strong>‚úÖ Synchronisation temps r√©el fonctionnelle !</strong><br>` +
                        `Les donn√©es ont chang√© automatiquement sans actualisation`
                    );

                    // Mettre √† jour les donn√©es de r√©f√©rence
                    lastKnownData.reservations = currentReservations;
                    lastKnownData.vehicles = currentVehicles;
                } else {
                    // Pas de changement - log discret
                    console.log('üîç V√©rification sync - Aucun changement d√©tect√©');
                }

            } catch (error) {
                addResult('error', '‚ùå Erreur v√©rification', error.message);
            }
        }

        async function checkSyncStatus() {
            try {
                const reservationsResponse = await fetch(`${SUPABASE_URL}/rest/v1/reservations`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                const vehiclesResponse = await fetch(`${SUPABASE_URL}/rest/v1/vehicles`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                const reservations = await reservationsResponse.json();
                const vehicles = await vehiclesResponse.json();

                addResult('info', 'üìä Statut Synchronisation', 
                    `üìÖ R√©servations: ${reservations.length}<br>` +
                    `üöó V√©hicules: ${vehicles.length}<br>` +
                    `üåê Connexion Supabase: ${reservationsResponse.ok && vehiclesResponse.ok ? '‚úÖ Active' : '‚ùå Erreur'}<br>` +
                    `‚è±Ô∏è Derni√®re v√©rification: ${new Date().toLocaleTimeString()}`
                );

            } catch (error) {
                addResult('error', '‚ùå Erreur statut', error.message);
            }
        }

        async function forceSync() {
            addResult('info', '‚ö° Synchronisation forc√©e', 'D√©clenchement manuel de la synchronisation...');
            await checkSyncStatus();
        }

        // Initialisation
        window.addEventListener('load', () => {
            addResult('info', 'üöÄ Test Temps R√©el Pr√™t', 
                `Utilisez les boutons ci-dessus pour tester la synchronisation.<br>` +
                `L'objectif est de v√©rifier que les modifications apparaissent automatiquement sur tous les appareils.`
            );
        });
    </script>
</body>
</html> 